cmake_minimum_required(VERSION 3.23)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

project(Bird)

add_custom_target(
  GenerateDependencies
  COMMAND
    cd ${CMAKE_SOURCE_DIR}/libs/bin && ${CMAKE_COMMAND} -G ${CMAKE_GENERATOR} ..
    -DCMAKE_BUILD_TYPE=Release "-DCMAKE_MAKE_PROGRAM=${CMAKE_MAKE_PROGRAM}" -G
    ${CMAKE_GENERATOR} && ${CMAKE_COMMAND} --build .
  VERBATIM)

link_directories(libs/GLFW/lib libs/ASSIMP/lib libs/GLEW/lib libs/SHADERC/lib
                 libs/SPIRV_CROSS/lib)

if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/libs/VOLK/src/VOLK")
  add_subdirectory(libs/VOLK/src/VOLK)
else()
  message(STATUS "VOLK directory not found, skipping.")
endif()

# src/ApplicationVK.cpp src/ApplicationVK.h
set(BIRD_FILES
    src/util/stb_image.h
    src/util/Constants.h
    src/util/Math.h
    src/util/Math.cpp
    src/util/File.cpp
    src/util/File.h
    src/util/Input.cpp
    src/util/Input.h
    src/Application.cpp
    src/Application.h
    src/util/ResourceManager.cpp
    src/util/ResourceManager.h
    src/util/Resource.cpp
    src/util/Resource.h)
add_library(Bird_core SHARED ${VOLK_SOURCE_FILE_PATH} ${BIRD_FILES})
add_executable(Bird src/main.cpp)
target_include_directories(Bird PRIVATE src/)
target_link_libraries(Bird Bird_core)
# add_dependencies(Bird GenerateDependencies)

target_link_options(Bird_core PRIVATE -Wl,-Bsymbolic)
set_target_properties(Bird_core PROPERTIES POSITION_INDEPENDENT_CODE TRUE)

if(APPLE)
  target_link_libraries(
    Bird
    PUBLIC "-framework Cocoa"
           "-framework IOKit"
           "-framework CoreVideo"
           "-framework OpenGL"
           "-framework AppKit"
           "-framework Metal"
           "-framework QuartzCore")
elseif(WIN32)
  target_link_libraries(Bird_core PUBLIC -luser32 -lkernel32 -lopengl32)
elseif(UNIX AND NOT APPLE)
  target_link_libraries(
    Bird_core
    PUBLIC -lX11
           -lXxf86vm
           -lXrandr
           -lpthread
           -lXi
           -ldl
           -lXinerama
           -lXcursor
           -lGL)
endif()

# add_library(include_lib PUBLIC

include_directories(libs/GLM/src/GLM libs/SHADERC/include
                    libs/SPIRV_CROSS/include)
target_include_directories(
  Bird_core
  PUBLIC $<INSTALL_INTERFACE:include>
  PUBLIC ${CMAKE_CURRENT_SOURCE_DIR}/src>
         # Or simply: PUBLIC ${CMAKE_CURRENT_SOURCE_DIR}/src (if headers are
         # here)
         libs/GLM/src/GLM
         libs/SHADERC/include
         libs/SPIRV_CROSS/include
         src/
         libs/SHADERC/include
         libs/SPIRV_CROSS/include)
add_subdirectory(src/renders)
include_directories(src/renders)
add_subdirectory(src/scene)
include_directories(src/scene)
target_include_directories(
  vulkan-renderer PUBLIC libs/VOLK/src/VOLK libs/VULKAN/src/VULKAN/include)

target_link_libraries(
  Bird_core
  PUBLIC scene
         renders
         stdc++
         -lglfw3
         -lassimp
         -lglew
         volk::volk
         -lshaderc_combined
         -lspirv-cross-core
         -lspirv-cross-glsl)
add_definitions(-Wno-deprecated-volatile)

# Build Tools
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR})
add_subdirectory(src/build-tools)

add_subdirectory(test)

install(
  DIRECTORY src/
  DESTINATION include
  FILES_MATCHING
  PATTERN "*.h"
  PATTERN "*.hpp"
  # This prevents installing the whole directory structure inside 'include' if
  # you want headers directly under 'include' Use PATTERN "*" EXCLUDE ".*" if
  # you want subdirectories
)
install(
  TARGETS Bird_core
  EXPORT Bird_Engine
  RUNTIME DESTINATION bin
  LIBRARY DESTINATION lib
  ARCHIVE DESTINATION lib
  INCLUDES
  DESTINATION include)

install(
  EXPORT Bird_Engine
  FILE Bird_EngineConfig.cmake
  NAMESPACE Bird::
  DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/Bird_Engine)
